name: Publish APK (manual)

on:
  workflow_dispatch:
    inputs:
      source:
        description: "Source of APK: artifact | url | repo"
        required: true
        default: "artifact"
      run_id:
        description: "Workflow run id to download artifact from (when source=artifact)"
        required: false
      artifact_name:
        description: "Artifact name (when source=artifact)"
        required: false
        default: "qrlinkki-staging-apk"
      apk_pattern:
        description: "Filename pattern inside artifact or repo (e.g. app-staging.apk)"
        required: false
        default: "app-staging.apk"
      apk_url:
        description: "Direct HTTPS URL to APK (when source=url)"
        required: false
      tag_name:
        description: "Tag name for release (optional). If empty, autogenerated."
        required: false
      release_name:
        description: "Release title (optional)"
        required: false
      prerelease:
        description: "Publish as prerelease? true/false"
        required: false
        default: 'true'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

    steps:
      - name: Download artifact (if selected)
        if: ${{ github.event.inputs.source == 'artifact' }}
        id: download_artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.artifact_name }}
          run-id: ${{ github.event.inputs.run_id }}
          path: ./artifacts

      - name: Get APK from artifact
        if: ${{ github.event.inputs.source == 'artifact' }}
        id: get_apk_from_artifact
        run: |
          apk_file=$(find ./artifacts -type f -name "${{ github.event.inputs.apk_pattern }}" -print -quit)
          if [ -z "$apk_file" ]; then echo "APK not found in artifact"; exit 1; fi
          echo "APK_PATH=$apk_file" >> $GITHUB_OUTPUT

      - name: Download APK from URL
        if: ${{ github.event.inputs.source == 'url' }}
        id: get_apk_from_url
        run: |
          set -e
          curl -L --fail -o apk_from_url.apk "${{ github.event.inputs.apk_url }}"
          echo "APK_PATH=$(pwd)/apk_from_url.apk" >> $GITHUB_OUTPUT

      - name: Checkout repo (if selected)
        if: ${{ github.event.inputs.source == 'repo' }}
        uses: actions/checkout@v4

      - name: Find APK in repo
        if: ${{ github.event.inputs.source == 'repo' }}
        id: get_apk_from_repo
        run: |
          apk_file=$(find . -type f -name "${{ github.event.inputs.apk_pattern }}" -print -quit)
          if [ -z "$apk_file" ]; then echo "APK not found in repo"; exit 1; fi
          echo "APK_PATH=$apk_file" >> $GITHUB_OUTPUT

      - name: Ensure release exists (idempotent)
        id: ensure_release
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const inputTag = `${{ github.event.inputs.tag_name }}`;
            const tag = (inputTag && inputTag.length) ? inputTag : `publish-${process.env.GITHUB_RUN_NUMBER}-${process.env.GITHUB_RUN_ID}`;
            const releaseName = `${{ github.event.inputs.release_name }}` || `Publish ${tag}`;
            const prerelease = `${{ github.event.inputs.prerelease }}` === 'true';
            try {
              const rel = await github.rest.repos.getReleaseByTag({ owner: context.repo.owner, repo: context.repo.repo, tag });
              core.info(`Found existing release ${tag} (id=${rel.data.id})`);
              core.setOutput('upload_url', rel.data.upload_url);
              core.setOutput('release_id', rel.data.id);
              core.setOutput('tag', tag);
            } catch (err) {
              if (err.status === 404) {
                const rel = await github.rest.repos.createRelease({ owner: context.repo.owner, repo: context.repo.repo, tag_name: tag, name: releaseName, body: `Published by workflow run ${process.env.GITHUB_RUN_ID}`, draft: false, prerelease });
                core.info(`Created release ${tag} (id=${rel.data.id})`);
                core.setOutput('upload_url', rel.data.upload_url);
                core.setOutput('release_id', rel.data.id);
                core.setOutput('tag', tag);
              } else { throw err; }
            }

      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.ensure_release.outputs.upload_url }}
          asset_path: ${{ steps.get_apk_from_artifact.outputs.APK_PATH || steps.get_apk_from_url.outputs.APK_PATH || steps.get_apk_from_repo.outputs.APK_PATH }}
          asset_name: app-staging.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Output release info
        run: |
          echo "Release: ${{ steps.ensure_release.outputs.tag }} (id=${{ steps.ensure_release.outputs.release_id }})"
